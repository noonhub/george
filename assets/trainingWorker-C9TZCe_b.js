(function(){"use strict";var s=(t=>(t[t.EMPTY=0]="EMPTY",t[t.WALL=1]="WALL",t[t.KID=2]="KID",t[t.ICE_CREAM=3]="ICE_CREAM",t[t.TV=4]="TV",t[t.FRIENDS=5]="FRIENDS",t[t.PLAYGROUND=6]="PLAYGROUND",t[t.HOMEWORK=7]="HOMEWORK",t[t.CHORE=8]="CHORE",t[t.CHORE_FEED_DOG=9]="CHORE_FEED_DOG",t[t.CHORE_CLEAN_ROOM=10]="CHORE_CLEAN_ROOM",t[t.CHORE_TAKE_OUT_TRASH=11]="CHORE_TAKE_OUT_TRASH",t[t.CHORE_READING_PRACTICE=12]="CHORE_READING_PRACTICE",t))(s||{}),E=(t=>(t[t.UP=0]="UP",t[t.DOWN=1]="DOWN",t[t.LEFT=2]="LEFT",t[t.RIGHT=3]="RIGHT",t))(E||{});const f={size:9,kidStart:[1,1],iceCream:[7,4],walls:[[2,3],[3,3],[5,2],[5,3]],funSpots:[{position:[1,5],type:"TV"},{position:[4,2],type:"FRIENDS"},{position:[6,3],type:"PLAYGROUND"}],chores:[{position:[2,1],label:"Feed the dog",type:s.CHORE_FEED_DOG},{position:[4,5],label:"Clean your room",type:s.CHORE_CLEAN_ROOM},{position:[2,6],label:"Do your math worksheet",type:s.HOMEWORK},{position:[5,6],label:"Take out the trash",type:s.CHORE_TAKE_OUT_TRASH},{position:[6,5],label:"Practice reading",type:s.CHORE_READING_PRACTICE},{position:[7,1],label:"Practice reading",type:s.CHORE_READING_PRACTICE},{position:[4,4],label:"Practice reading",type:s.CHORE_READING_PRACTICE}]};s.EMPTY+"",s.WALL+"",s.KID+"",s.ICE_CREAM+"",s.TV+"",s.FRIENDS+"",s.PLAYGROUND+"",s.HOMEWORK+"",s.CHORE+"",s.CHORE_FEED_DOG+"",s.CHORE_CLEAN_ROOM+"",s.CHORE_TAKE_OUT_TRASH+"",s.CHORE_READING_PRACTICE+"",s.KID+"",s.ICE_CREAM+"",s.TV+"",s.FRIENDS+"",s.PLAYGROUND+"",s.HOMEWORK+"",s.CHORE+"",s.CHORE_FEED_DOG+"",s.CHORE_CLEAN_ROOM+"",s.CHORE_TAKE_OUT_TRASH+"",s.CHORE_READING_PRACTICE+"";const Y={[E.UP]:[-1,0],[E.DOWN]:[1,0],[E.LEFT]:[0,-1],[E.RIGHT]:[0,1]},q=[E.UP,E.DOWN,E.LEFT,E.RIGHT],z={TV:{label:"Watch TV",funReward:12,timePenalty:3,energyBoost:1},FRIENDS:{label:"Play with friends",funReward:8,timePenalty:2,energyBoost:3},PLAYGROUND:{label:"Go to the playground",funReward:5,timePenalty:1,energyBoost:4}},U={TV:s.TV,FRIENDS:s.FRIENDS,PLAYGROUND:s.PLAYGROUND},K={[s.TV]:"TV",[s.FRIENDS]:"FRIENDS",[s.PLAYGROUND]:"PLAYGROUND"},$=f.funSpots.reduce((t,e)=>(t[`${e.position[0]},${e.position[1]}`]=e.type,t),{}),Q=f.chores.reduce((t,e)=>(t[`${e.position[0]},${e.position[1]}`]=e.label,t),{}),j=[s.CHORE,s.CHORE_FEED_DOG,s.CHORE_CLEAN_ROOM,s.CHORE_TAKE_OUT_TRASH,s.CHORE_READING_PRACTICE,s.HOMEWORK],Z=new Set(j),L={learningRate:.1,discountFactor:.99,epsilon:1,epsilonDecay:.9995,minEpsilon:.01,episodes:2e3,episodeHardCap:200,speed:50,timeLimit:35,timeCostPerMove:1,choreTimeBonus:4,requiredChores:3,timeBucketSize:4,funRewardScale:1,energy:30,energyMoveCost:1,choreEnergyCost:2,energyBucketSize:3,distractionTypes:z,distractionLayout:$,defaultDistractionType:"PLAYGROUND",choreAssignments:Q,rewards:{goal:100,step:-1,failure:-100,distractionBonus:5,choreReward:10,revisitPenalty:-1,earlyIceCreamPenalty:-25,bedtimeFailure:-100,meltdownFailure:-100}};function J(){const t=f.size,e=Array(t).fill(null).map(()=>Array(t).fill(s.EMPTY));for(let n=0;n<t;n++)e[0][n]=s.WALL,e[t-1][n]=s.WALL,e[n][0]=s.WALL,e[n][t-1]=s.WALL;const i=(n,r)=>{e[n[0]][n[1]]=r};i(f.kidStart,s.KID),i(f.iceCream,s.ICE_CREAM),f.chores.forEach(n=>i(n.position,n.type));const o=U[L.defaultDistractionType]??s.PLAYGROUND;return f.funSpots.forEach(n=>{const r=U[n.type]??o;i(n.position,r)}),f.walls.forEach(n=>i(n,s.WALL)),e}const X=[[-1,0],[1,0],[0,-1],[0,1]],A=t=>`${t[0]},${t[1]}`;class v{constructor(e,i){this.grid=e.map(o=>[...o]),this.size=e.length,this.config=i,this.agentStartPos=this.findTile(s.KID),this.goalPos=this.findTile(s.ICE_CREAM),this.agentPos=this.agentStartPos,this.timeRemaining=i.timeLimit,this.energy=i.energy,this.distractionsVisited=new Set,this.visitCounts=new Map([[A(this.agentStartPos),1]]),this.choresCompleted=new Set,this.choresDoneCount=0}findTile(e){for(let i=0;i<this.size;i++)for(let o=0;o<this.size;o++)if(this.grid[i][o]===e)return[i,o];throw new Error(`Tile of type ${e} not found in grid.`)}getAgentStartState(){return this.agentStartPos}getRemainingSteps(){return this.timeRemaining}getResources(){return{timeRemaining:this.timeRemaining,energy:this.energy,choresDone:this.choresDoneCount,requiredChores:this.config.requiredChores,funVisited:this.distractionsVisited.size}}reset(){return this.agentPos=this.agentStartPos,this.timeRemaining=this.config.timeLimit,this.energy=this.config.energy,this.distractionsVisited=new Set,this.visitCounts=new Map([[A(this.agentStartPos),1]]),this.choresCompleted=new Set,this.choresDoneCount=0,this.getObservedState()}getObservedState(e=this.agentPos){const i=X.reduce((n,[r,h],c)=>{const l=[e[0]+r,e[1]+h];return(this.visitCounts.get(A(l))??0)>0?n|1<<c:n},0),o=(n,r)=>Math.max(0,Math.ceil(n/Math.max(r,1)));return{position:e,visitMask:i,timeBucket:o(this.timeRemaining,this.config.timeBucketSize),energyBucket:o(this.energy,this.config.energyBucketSize),choresDone:this.choresDoneCount}}applyResourceFailure(){return this.timeRemaining<0||this.timeRemaining===0?{nextState:this.getObservedState(),reward:this.config.rewards.bedtimeFailure??this.config.rewards.failure,done:!0,status:"FAILURE"}:this.energy<=0?{nextState:this.getObservedState(),reward:this.config.rewards.meltdownFailure??this.config.rewards.failure,done:!0,status:"FAILURE"}:null}getDistractionKey(e,i){return this.config.distractionLayout[i]??K[e]??this.config.defaultDistractionType}getDistractionType(e,i){const o=this.getDistractionKey(i,e);return this.config.distractionTypes[o]??this.config.distractionTypes[this.config.defaultDistractionType]}canCelebrate(){return this.choresDoneCount>=this.config.requiredChores&&this.timeRemaining>=0&&this.energy>0}step(e){const[i,o]=Y[e],[n,r]=this.agentPos,h=[n+i,r+o],[c,l]=h,a=A(h);this.timeRemaining-=this.config.timeCostPerMove,this.energy-=this.config.energyMoveCost;let R=this.config.rewards.step;if(c<0||c>=this.size||l<0||l>=this.size||this.grid[c][l]===s.WALL){const d=this.applyResourceFailure();return d||{nextState:this.getObservedState(),reward:R,done:!1,status:"IN_PROGRESS"}}this.agentPos=h;const P=this.visitCounts.get(a)??0,W=P===0;this.visitCounts.set(a,P+1);const N=this.grid[c][l];if(K[N]!==void 0){const d=this.getDistractionType(a,N);W?(R+=d.funReward*(this.config.funRewardScale??1),this.timeRemaining-=d.timePenalty,this.energy=Math.min(this.config.energy,this.energy+d.energyBoost),this.distractionsVisited.add(a)):R+=this.config.rewards.revisitPenalty}else if(Z.has(N))this.choresCompleted.has(a)?R+=this.config.rewards.revisitPenalty:(this.choresCompleted.add(a),this.choresDoneCount+=1,R+=this.config.rewards.choreReward,this.timeRemaining+=this.config.choreTimeBonus),this.energy-=this.config.choreEnergyCost;else switch(N){case s.ICE_CREAM:{if(this.canCelebrate()){const d=this.distractionsVisited.size*this.config.rewards.distractionBonus,ot=this.config.rewards.goal+d;return{nextState:this.getObservedState(),reward:ot,done:!0,status:"SUCCESS"}}R+=this.config.rewards.earlyIceCreamPenalty;break}default:W||(R+=this.config.rewards.revisitPenalty)}const B=this.applyResourceFailure();return B||{nextState:this.getObservedState(),reward:R,done:!1,status:"IN_PROGRESS"}}}function m(t){const[e,i]=t.position;return`${e},${i}|${t.visitMask}|t${t.timeBucket}|e${t.energyBucket}|c${t.choresDone}`}class x{constructor(e){this.qTable={},this.config=e,this.actions=q,this.currentEpsilon=e.epsilon}getQValue(e,i){var n;const o=m(e);return((n=this.qTable[o])==null?void 0:n[i])??0}chooseAction(e){if(Math.random()<this.currentEpsilon)return this.actions[Math.floor(Math.random()*this.actions.length)];{const i=m(e),o=this.qTable[i]??{};let n=this.actions[0],r=-1/0;for(const h of this.actions){const c=o[h]??0;c>r&&(r=c,n=h)}return n}}updateQValue(e,i,o,n){const r=this.getQValue(e,i),h=m(n),c=this.qTable[h]??{};let l=-1/0;Object.keys(c).length>0?l=Math.max(...Object.values(c).map(P=>P||0)):l=0;const a=r+this.config.learningRate*(o+this.config.discountFactor*l-r),R=m(e);this.qTable[R]||(this.qTable[R]={}),this.qTable[R][i]=a}trainEpisode(e){let i=e.reset();const o=[i.position];let n=0,r=0,h=!1,c="FAILURE";for(;!h&&r<this.config.episodeHardCap;){const l=this.chooseAction(i),a=e.step(l);this.updateQValue(i,l,a.reward,a.nextState),i=a.nextState,o.push(a.nextState.position),n+=a.reward,r++,h=a.done,a.done&&(c=a.status)}return this.currentEpsilon=Math.max(this.config.minEpsilon,this.currentEpsilon*this.config.epsilonDecay),{steps:r,totalReward:n,status:c,path:o,remainingSteps:e.getRemainingSteps(),resources:e.getResources()}}getQTable(){return this.qTable}reset(){this.qTable={},this.currentEpsilon=this.config.epsilon}setConfig(e){const i=e.epsilon!==this.config.epsilon;this.config=e,i&&(this.currentEpsilon=this.config.epsilon)}}const _=self,w=10,H=t=>({timeRemaining:t.timeLimit,energy:t.energy,choresDone:0,requiredChores:t.requiredChores,funVisited:0});let M=J(),u=L,O=null,g=null,C=!1,p=0,D=w,S=[],I=[],F=[],y=H(L),T=null;const tt=t=>t.map(e=>[...e]),b=()=>{T&&(clearTimeout(T),T=null)},k=()=>{O=new v(M,u),g=new x(u),p=0,y=H(u),F=[O.getAgentStartState()],S=[],I=[]},G=t=>{if(!g||S.length===0&&t==="RUNNING")return;const e={type:"BATCH_UPDATE",payload:{stats:S,routes:I,agentPath:F,resources:y,currentEpisode:p,trainingState:t,qTable:g.getQTable()}};_.postMessage(e),S=[],I=[]},V=()=>{b();const t=Math.max(1,Math.floor(1e3/Math.max(u.speed,1)));T=setTimeout(et,t)},et=()=>{if(!C||!O||!g)return;if(p>=u.episodes){C=!1,G("COMPLETE");return}const t=g.trainEpisode(O);p+=1;const e={episode:p,steps:t.steps,totalReward:t.totalReward,status:t.status};S.push(e),I.push({path:t.path,reward:t.totalReward}),F=t.path,y=t.resources;const i=p>=u.episodes;if((S.length>=D||i)&&G(i?"COMPLETE":"RUNNING"),i){C=!1,b();return}C&&V()},st=t=>{(!O||!g)&&k(),D=t||w,D<=0&&(D=w),!C&&(C=!0,V())},it=()=>{C=!1,b(),G("PAUSED")},nt=t=>{switch(t.type){case"RESET":b(),C=!1,M=tt(t.grid),u=t.config,k();break;case"SET_CONFIG":u=t.config,g?g.setConfig(u):g=new x(u),O=new v(M,u),y=H(u);break;case"START":st(t.batchSize);break;case"PAUSE":it();break;default:_.postMessage({type:"ERROR",payload:{message:`Unknown command: ${t.type}`}})}};_.onmessage=t=>{try{nt(t.data)}catch(e){_.postMessage({type:"ERROR",payload:{message:e instanceof Error?e.message:"Unknown worker error"}})}}})();
